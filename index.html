<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Kiosko Campamento</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="kiosk-container">
    <h1>üè™ Kiosko GJ</h1>
    <div class="main-actions-bar main-actions-bar-right">
      <button onclick="window.location.href='stats.html'" class="btn-stats-top" title="Ver estad√≠sticas">üìä REGISTROS</button>
      <button onclick="window.location.href='setup.html'" class="btn-settings-corner" title="Ajustes">‚öôÔ∏è AJUSTES</button>
      <button onclick="window.location.href='castigos.html'" class="btn-castigos-corner" title="Ver castigos">üëø CASTIGOS</button>
    </div>

    <div class="user-selection">
      <div class="select-group">
        <label for="grupo">üë• Grupo</label>
        <select id="grupo">
          <option value="">Selecciona grupo</option>
        </select>
      </div>
      <div class="select-group">
        <label for="nino">üë§ Ni√±o</label>
        <select id="nino" disabled>
          <option value="">Selecciona ni√±o</option>
        </select>
      </div>
    </div>

    <!-- NUEVO: Info de saldo y compra del ni√±o -->
    <div id="info-nino" class="info-nino-card"></div>

    <div class="order-section">
      <h2>üõí Pedido</h2>
      <div id="productos"></div>
    </div>

    <!-- Nueva secci√≥n para tokens -->
    <div class="token-section">
      <h2>ü™ô Tokens</h2>
      
      <!-- Informaci√≥n del bonus y bot√≥n de activaci√≥n -->
      <div id="token-bonus" class="token-bonus-info">
        <div class="bonus-status-row">
          <div class="bonus-info">
            <span class="bonus-label">Estado del Bonus:</span>
            <span id="bonus-estado" class="bonus-estado">Cargando...</span>
          </div>
          <button id="btn-activar-bonus" class="btn-activar-bonus" style="display: none;" onclick="activarBonus()">
            üöÄ Activar Bonus +50%
          </button>
        </div>
      </div>
      
      <div class="token-controls" style="display: flex; justify-content: center; align-items: center; gap: 10px; padding: 15px;">
        <label for="tokens-cantidad" style="font-weight: 600; color: #475569;">Cantidad a a√±adir/quitar:</label>
        <div style="display: flex; align-items: center; gap: 8px;">
          <button type="button" class="btn-cantidad" onclick="cambiarTokens(-1)">-</button>
          <input type="number" id="tokens-cantidad" value="0" min="-100" max="100" style="width: 60px; text-align: center; border: 2px solid #e2e8f0; border-radius: 4px; padding: 8px 4px; font-size: 1rem; font-weight: 600;">
          <button type="button" class="btn-cantidad" onclick="cambiarTokens(1)">+</button>
        </div>
      </div>
      
      <div id="tokens-preview" class="tokens-preview" style="text-align: center; margin-top: 10px; margin-bottom: 10px;"></div>
    </div>
    <br>

    <div class="total-section">
      <p>Total: <span id="total">0.00</span> ‚Ç¨</p>
    </div>

    <div class="button-group">
      <button onclick="confirmarCompra()" class="btn-confirm">‚úÖ Confirmar</button>
    </div>

    <div id="mensaje"></div>
  </div>
  <!-- Bot√≥n de ayuda flotante y barra de acciones vertical -->
  <div class="floating-actions-vertical">
    <button id="btn-ayuda" class="btn-ayuda-rect" onclick="iniciarTutorial()" title="Ayuda">
      <span style="font-size:1.3em;">?</span>
      <span class="btn-label">AYUDA</span>
    </button>
    <button onclick="window.location.href='stats.html'" class="btn-stats-vertical" title="Ver estad√≠sticas">
      <span style="font-size:1.3em;">üìä</span>
      <span class="btn-label">REGISTROS</span>
    </button>
    <button onclick="window.location.href='setup.html'" class="btn-settings-vertical" title="Ajustes">
      <span style="font-size:1.3em;">‚öôÔ∏è</span>
      <span class="btn-label">AJUSTES</span>
    </button>
    <button onclick="window.location.href='castigos.html'" class="btn-castigos-vertical" title="Ver castigos" style="background:linear-gradient(45deg,#ef4444,#b91c1c);">
      <span style="font-size:1.3em;">üëø</span>
      <span class="btn-label">CASTIGOS</span>
    </button>
  </div>
  <!-- Easter egg DKNS/Cuadrado -->
  <div id="easteregg-dkns" style="display:none; position:fixed; bottom:24px; left:24px; z-index:99999; background:rgba(67,56,202,0.97); color:white; padding:22px 28px; border-radius:16px; box-shadow:0 8px 32px rgba(67,56,202,0.18); font-size:1.15em; font-family:monospace; text-align:center;">
    <div style="font-size:2em; margin-bottom:8px;">üêâ</div>
    <div><b>DKNS</b> - Powered by DKNSoftware</div>
    <div style="font-size:0.95em; margin-top:8px;">¬°Gracias por usar la app!<br>¬øSab√≠as que Cuadrado es el mejor? ¬øNO? Pues deberias saberlo</div>
    <button onclick="document.getElementById('easteregg-dkns').style.display='none'" style="margin-top:14px; background:#64748b; color:white; border:none; border-radius:6px; padding:7px 18px; font-size:1em; font-weight:600; cursor:pointer;">Cerrar</button>
  </div>
  <style>
    /* Tutorial popup styles mejorados */
    .tutorial-popup {
      position: fixed;
      z-index: 20000;
      background: #f8fafc;
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(67,56,202,0.18);
      padding: 22px 22px 18px 22px;
      min-width: 260px;
      max-width: 340px;
      border: 2px solid #4338ca;
      font-size: 1rem;
      color: #1e293b;
      transition: box-shadow 0.2s;
      pointer-events: auto;
      display: flex;
      flex-direction: column;
      align-items: stretch;
    }
    .tutorial-popup .tutorial-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 10px;
    }
    .tutorial-popup .tutorial-numero {
      background: #4338ca;
      color: white;
      border-radius: 6px;
      padding: 2px 10px;
      font-size: 0.95em;
      font-weight: bold;
      margin-right: 8px;
    }
    .tutorial-popup h3 {
      font-size: 1.1em;
      margin: 0;
      flex: 1;
      color: #4338ca;
      font-weight: 700;
      letter-spacing: 0.01em;
    }
    .tutorial-popup .tutorial-cerrar {
      background: none;
      border: none;
      color: #dc2626;
      font-size: 1.2em;
      font-weight: bold;
      cursor: pointer;
      margin-left: 8px;
      transition: color 0.2s;
      line-height: 1;
      padding: 0 6px;
      border-radius: 4px;
      height: 28px;
      width: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .tutorial-popup .tutorial-cerrar:hover {
      background: #fee2e2;
      color: #b91c1c;
    }
    .tutorial-popup .tutorial-contenido {
      margin-bottom: 16px;
      font-size: 1.05em;
      color: #374151;
      line-height: 1.5;
      word-break: break-word;
    }
    .tutorial-popup .tutorial-botones {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 8px;
    }
    .tutorial-popup .tutorial-botones button {
      background: linear-gradient(45deg, #4338ca, #6b21a8);
      color: white;
      border: none;
      border-radius: 6px;
      padding: 7px 18px;
      font-size: 1em;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
      box-shadow: 0 2px 8px rgba(67,56,202,0.10);
      min-width: 110px;
      margin: 0;
      white-space: nowrap;
      outline: none;
    }
    .tutorial-popup .tutorial-botones button:hover {
      background: linear-gradient(45deg, #3730a3, #581c87);
    }
    .tutorial-destacado {
      outline: 3px solid #4338ca !important;
      box-shadow: 0 0 0 6px #c7d2fe !important;
      border-radius: 8px !important;
      position: relative;
      z-index: 19999 !important;
      transition: box-shadow 0.2s;
    }
    /* Popup positioning */
    .tutorial-popup.tutorial-arriba {
      transform: translate(-50%, -100%);
      top: 0;
      left: 50%;
    }
    .tutorial-popup.tutorial-abajo {
      transform: translate(-50%, 10px);
      top: unset;
      left: 50%;
      bottom: unset;
    }
    .tutorial-popup.tutorial-izquierda {
      transform: translate(-105%, -50%);
      left: 0;
      top: 50%;
    }
    .tutorial-popup.tutorial-derecha {
      transform: translate(10px, -50%);
      left: unset;
      right: 0;
      top: 50%;
    }
    @media (max-width: 600px) {
      .tutorial-popup {
        min-width: 180px;
        max-width: 95vw;
        padding: 12px 8px 10px 8px;
        font-size: 0.98em;
      }
      .tutorial-popup .tutorial-botones {
        flex-direction: column;
        gap: 8px;
        align-items: stretch;
      }
      .tutorial-popup .tutorial-botones button {
        min-width: 0;
        width: 100%;
      }
    }

    #easteregg-dkns {
      animation: dkns-pop 0.4s cubic-bezier(.68,-0.55,.27,1.55);
    }
    @keyframes dkns-pop {
      0% { transform: scale(0.7) translateY(40px); opacity: 0; }
      80% { transform: scale(1.05) translateY(-6px); opacity: 1; }
      100% { transform: scale(1) translateY(0); opacity: 1; }
    }
    .token-section {
      margin-top: 20px;
      padding: 16px;
      background: #fffab3;
      border-radius: 8px;
      border: 3px solid #e0c238;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .token-bonus-info {
      background: rgba(255, 255, 255, 0.9);
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      text-align: center;
      border: 2px solid #d4af37;
    }
    
    .bonus-status-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 15px;
      flex-wrap: wrap;
    }
    
    .bonus-info {
      display: flex;
      align-items: center;
      gap: 10px;
      flex: 1;
      min-width: 200px;
    }
    
    .bonus-display {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 15px;
      flex-wrap: wrap;
    }
    
    .bonus-label {
      font-weight: 600;
      color: #8b4513;
      font-size: 1.1em;
    }
    
    .bonus-estado {
      font-weight: 700;
      font-size: 1.1em;
      padding: 6px 15px;
      border-radius: 8px;
      color: white;
      min-width: 120px;
    }
    
    .bonus-estado.activo {
      background: linear-gradient(45deg, #10b981, #059669);
      animation: pulse-bonus 2s infinite;
    }
    
    .bonus-estado.inactivo {
      background: linear-gradient(45deg, #6b7280, #4b5563);
    }
    
    .bonus-estado.cooldown {
      background: linear-gradient(45deg, #ef4444, #dc2626);
    }
    
    .btn-activar-bonus {
      background: linear-gradient(45deg, #f59e0b, #d97706);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 10px 20px;
      font-size: 1em;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 3px 10px rgba(245, 158, 11, 0.3);
    }
    
    .btn-activar-bonus:hover {
      background: linear-gradient(45deg, #d97706, #b45309);
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(245, 158, 11, 0.4);
    }
    
    .btn-activar-bonus:disabled {
      background: #9ca3af;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    @keyframes pulse-bonus {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    
    .tokens-preview {
      font-size: 0.9em;
      color: #6b7280;
      font-weight: 600;
      min-height: 20px;
    }
    
    .tokens-preview.activo {
      color: #059669;
    }
    
    .tokens-preview.bonus {
      color: #f59e0b;
      font-weight: 700;
    }
    
    @media (max-width: 600px) {
      .bonus-display {
        flex-direction: column;
        gap: 10px;
      }
      
      .bonus-status-row {
        flex-direction: column;
        gap: 12px;
        text-align: center;
      }
      
      .bonus-info {
        justify-content: center;
        min-width: auto;
      }
    }
  </style>
  <script>
    let productosDB = [];
    let LIMITE_DIARIO = 2.50; // Valor por defecto
    
    // Sistema de tutorial guiado
    const pasosTutorial = [
      {
        elemento: '.user-selection',
        titulo: 'Selecci√≥n de usuario',
        mensaje: 'Aqu√≠ puedes seleccionar primero un grupo y luego un ni√±o para realizar una compra.',
        posicion: 'abajo'
      },
      {
        elemento: '#productos',
        titulo: 'Productos disponibles',
        mensaje: 'Puedes usar los botones + y - para ajustar la cantidad.',
        posicion: 'arriba'
      },
      {
        elemento: '.total-section',
        titulo: 'Total del pedido',
        mensaje: 'Aqu√≠ ver√°s el total a pagar. Si supera el l√≠mite diario recomendado, se mostrar√° en rojo.',
        posicion: 'arriba'
      },
      {
        elemento: '.btn-confirm',
        titulo: 'Confirmar pedido',
        mensaje: 'Una vez seleccionados los productos, haz clic aqu√≠ para finalizar la compra. Ojo a los castigados',
        posicion: 'izquierda'
      }
    ];
    
    let pasoActual = 0;
    let popupTutorial = null;
    
    function iniciarTutorial() {
      pasoActual = 0;
      mostrarPasoTutorial();
      // No modificar el bot√≥n de ayuda
    }
    
    function mostrarPasoTutorial() {
      if (popupTutorial) {
        popupTutorial.remove();
        popupTutorial = null;
      }
      if (pasoActual >= pasosTutorial.length) {
        finalizarTutorial();
        return;
      }
      const paso = pasosTutorial[pasoActual];
      // Permitir m√∫ltiples selectores separados por coma
      let elemento = null;
      if (paso.elemento.includes(',')) {
        const selectors = paso.elemento.split(',').map(s => s.trim());
        for (const sel of selectors) {
          elemento = document.querySelector(sel);
          if (elemento) break;
        }
      } else {
        elemento = document.querySelector(paso.elemento);
      }
      if (!elemento) {
        pasoActual++;
        mostrarPasoTutorial();
        return;
      }
      // Crear popup
      popupTutorial = document.createElement('div');
      popupTutorial.className = `tutorial-popup tutorial-${paso.posicion}`;
      popupTutorial.innerHTML = `
        <div class="tutorial-header">
          <span class="tutorial-numero">${pasoActual + 1}/${pasosTutorial.length}</span>
          <h3>${paso.titulo}</h3>
          <button class="tutorial-cerrar" onclick="finalizarTutorial()">√ó</button>
        </div>
        <div class="tutorial-contenido">
          <p>${paso.mensaje}</p>
        </div>
        <div class="tutorial-botones">
          ${pasoActual > 0 ? `<button onclick="pasoPrevio()">¬´ Anterior</button>` : ''}
          <button onclick="pasoSiguiente()">${pasoActual < pasosTutorial.length - 1 ? 'Siguiente ¬ª' : 'Finalizar'}</button>
        </div>
      `;
      document.body.appendChild(popupTutorial);

      // Destacar el elemento actual
      elemento.classList.add('tutorial-destacado');

      // Posicionar popup
      setTimeout(() => {
        posicionarPopup(popupTutorial, elemento, paso.posicion);
      }, 0);
    }

    function posicionarPopup(popup, elemento, posicion) {
      const rect = elemento.getBoundingClientRect();
      const popupRect = popup.getBoundingClientRect();
      let top = 0, left = 0;
      switch(posicion) {
        case 'arriba':
          top = window.scrollY + rect.top - popupRect.height - 12;
          left = window.scrollX + rect.left + rect.width / 2 - popupRect.width / 2;
          break;
        case 'abajo':
          top = window.scrollY + rect.bottom + 12;
          left = window.scrollX + rect.left + rect.width / 2 - popupRect.width / 2;
          break;
        case 'izquierda':
          top = window.scrollY + rect.top + rect.height / 2 - popupRect.height / 2;
          left = window.scrollX + rect.left - popupRect.width - 12;
          break;
        case 'derecha':
          top = window.scrollY + rect.top + rect.height / 2 - popupRect.height / 2;
          left = window.scrollX + rect.right + 12;
          break;
        default:
          top = window.scrollY + rect.bottom + 12;
          left = window.scrollX + rect.left + rect.width / 2 - popupRect.width / 2;
      }
      // Ajuste para que no se salga de la pantalla
      top = Math.max(8, Math.min(top, window.innerHeight - popupRect.height - 8));
      left = Math.max(8, Math.min(left, window.innerWidth - popupRect.width - 8));
      popup.style.top = `${top}px`;
      popup.style.left = `${left}px`;
    }
    
    function pasoSiguiente() {
      const pasoActualObj = pasosTutorial[pasoActual];
      // Quitar destacado del elemento actual
      if (pasoActualObj.elemento.includes(',')) {
        const selectors = pasoActualObj.elemento.split(',').map(s => s.trim());
        for (const sel of selectors) {
          const el = document.querySelector(sel);
          if (el) el.classList.remove('tutorial-destacado');
        }
      } else {
        const elementoActual = document.querySelector(pasoActualObj.elemento);
        if (elementoActual) elementoActual.classList.remove('tutorial-destacado');
      }
      pasoActual++;
      mostrarPasoTutorial();
    }
    
    function pasoPrevio() {
      const pasoActualObj = pasosTutorial[pasoActual];
      if (pasoActualObj.elemento.includes(',')) {
        const selectors = pasoActualObj.elemento.split(',').map(s => s.trim());
        for (const sel of selectors) {
          const el = document.querySelector(sel);
          if (el) el.classList.remove('tutorial-destacado');
        }
      } else {
        const elementoActual = document.querySelector(pasoActualObj.elemento);
        if (elementoActual) elementoActual.classList.remove('tutorial-destacado');
      }
      pasoActual--;
      mostrarPasoTutorial();
    }
    
    function finalizarTutorial() {
      if (popupTutorial) {
        popupTutorial.remove();
        popupTutorial = null;
      }
      // Quitar destacado de todos los elementos
      document.querySelectorAll('.tutorial-destacado').forEach(el => {
        el.classList.remove('tutorial-destacado');
      });
      // No modificar el bot√≥n de ayuda
    }

    // Cargar configuraci√≥n al inicio
    function cargarConfiguracion() {
      fetch('/api/configuracion')
        .then(res => res.json())
        .then(config => {
          LIMITE_DIARIO = config.cotaDiaria || 2.50;
        })
        .catch(() => {
          // Si no hay configuraci√≥n, usar valor por defecto
          LIMITE_DIARIO = 2.50;
        });
    }

    // Cargar productos desde el backend
    function cargarProductos() {
      fetch('/api/productos')
        .then(res => res.json())
        .then(productos => {
          productosDB = productos;
          const productosContainer = document.getElementById('productos');
          productosContainer.innerHTML = '';
          productos.forEach(producto => {
            const label = document.createElement('label');
            label.className = 'producto-card-clickable';
            
            // Create the HTML content
            label.innerHTML = `
              <div class="producto-info">
                <span class="producto-nombre">${producto.nombre}</span>
                <span class="price">${producto.precio.toFixed(2)}‚Ç¨</span>
              </div>
              <div class="cantidad-controls">
                <button type="button" class="btn-cantidad" id="btn-minus-${producto.id}">-</button>
                <input type="number" class="cantidad-input" id="cantidad-${producto.id}" 
                       value="0" min="0" max="20" data-precio="${producto.precio}">
                <button type="button" class="btn-cantidad" id="btn-plus-${producto.id}">+</button>
              </div>
            `;
            
            productosContainer.appendChild(label);
            
            // Add click handlers after the element is in the DOM
            document.getElementById(`btn-minus-${producto.id}`).onclick = (e) => {
              e.stopPropagation();
              cambiarCantidad(producto.id, -1);
            };
            
            document.getElementById(`btn-plus-${producto.id}`).onclick = (e) => {
              e.stopPropagation();
              cambiarCantidad(producto.id, 1);
            };
            
            document.getElementById(`cantidad-${producto.id}`).onchange = (e) => {
              e.stopPropagation();
              actualizarTotal();
            };
            
            // Add click handler to the label itself
            label.onclick = function() {
              // Skip if clicked on a button or input
              if (event.target.tagName === 'BUTTON' || event.target.tagName === 'INPUT') {
                return;
              }
              
              // Add product to cart
              cambiarCantidad(producto.id, 1);
              
              // Visual feedback
              this.classList.add('clicked');
              setTimeout(() => this.classList.remove('clicked'), 200);
            };
          });
        });
    }

    // Cargar grupos √∫nicos desde la base de datos
    let ninosDB = [];
    fetch('/api/ninos')
      .then(res => res.json())
      .then(ninos => {
        ninosDB = ninos;
        const grupos = [...new Set(ninos.map(n => n.grupo))].sort((a, b) => a - b);
        const grupoSelect = document.getElementById('grupo');
        grupos.forEach(grupo => {
          const opt = document.createElement('option');
          opt.value = grupo;
          opt.textContent = grupo;
          grupoSelect.appendChild(opt);
        });
      });

    // Mostrar info de saldo, compra y castigo al seleccionar ni√±o
    document.getElementById('nino').addEventListener('change', function() {
      const ninoId = this.value;
      const infoDiv = document.getElementById('info-nino');
      infoDiv.textContent = '';
      infoDiv.className = 'info-nino-card'; // reset classes
      if (!ninoId) {
        infoDiv.textContent = '';
        return;
      }
      // Consultar saldo, si ha comprado hoy y si est√° castigado
      Promise.all([
        fetch(`/api/ninos/${ninoId}/info`).then(res => {
          if (!res.ok) throw new Error('No se pudo consultar el ni√±o');
          return res.json();
        }),
        fetch('/api/castigos').then(res => res.json())
      ])
      .then(([data, castigos]) => {
        let saldo = typeof data.saldo === 'number' ? data.saldo.toFixed(2) : '--';
        let comprado = data.compradoHoy ? 'S√≠' : 'No';
        let color = data.compradoHoy ? '#dc2626' : '#10b981';
        let icon = data.compradoHoy
          ? '<span class="info-nino-icon" style="background:#fee2e2;color:#dc2626;">&#9888;</span>'
          : '<span class="info-nino-icon" style="background:#d1fae5;color:#10b981;">&#10003;</span>';

        // Castigo
        let castigado = castigos[ninoId] && castigos[ninoId] > Date.now();
        let castigoColor = castigado ? '#dc2626' : '#10b981';
        let castigoIcon = castigado
          ? '<span class="info-nino-icon" style="background:#fee2e2;color:#dc2626;">&#9940;</span>'
          : '<span class="info-nino-icon" style="background:#d1fae5;color:#10b981;">&#10003;</span>';
        let castigoTexto = castigado
          ? `S√≠ <span style="font-size:0.95em;color:#991b1b;">(hasta ${new Date(castigos[ninoId]).toLocaleString('es-ES')})</span>`
          : 'No';

        // Mostrar tokens si est√°n disponibles
        const tokens = data.tokens !== undefined ? data.tokens : 0;

        infoDiv.innerHTML = `
          <div class="info-nino-flex">
            <div>
              <span class="info-nino-label">üí∞ Saldo:</span>
              <span class="info-nino-value" style="color:#4338ca">${saldo}‚Ç¨</span>
            </div>
            <div>
              <span class="info-nino-label">ü™ô Tokens:</span>
              <span class="info-nino-value" style="color:#ca8a04">${tokens}</span>
            </div>
            <div>
              <span class="info-nino-label">üóìÔ∏è ¬øHa comprado hoy?:</span>
              <span class="info-nino-value" style="color:${color};font-weight:700">${comprado}</span>
              ${icon}
            </div>
            <div>
              <span class="info-nino-label">üö´ ¬øEst√° castigado?:</span>
              <span class="info-nino-value" style="color:${castigoColor};font-weight:700">${castigoTexto}</span>
              ${castigoIcon}
            </div>
          </div>
        `;
      })
      .catch(() => {
        infoDiv.innerHTML = '<div class="info-nino-error">‚ö†Ô∏è No se pudo consultar el ni√±o seleccionado.</div>';
      });
    });

    document.getElementById('grupo').addEventListener('change', function() {
      const grupo = this.value;
      const ninoSelect = document.getElementById('nino');
      ninoSelect.innerHTML = '<option value="">Selecciona ni√±o</option>';
      if (!grupo) {
        ninoSelect.disabled = true;
        return;
      }
      const filtrados = ninosDB
        .filter(n => n.grupo.toString() === grupo)
        .sort((a, b) => (a.nombre + ' ' + a.apellidos).localeCompare(b.nombre + ' ' + b.apellidos));
      filtrados.forEach(nino => {
        const opt = document.createElement('option');
        opt.value = nino.id;
        opt.textContent = nino.nombre + ' ' + nino.apellidos;
        ninoSelect.appendChild(opt);
      });
      ninoSelect.disabled = false;
    });

    // Funci√≥n para cambiar cantidad con botones
    window.cambiarCantidad = function(productoId, delta) {
      const input = document.getElementById(`cantidad-${productoId}`);
      const nuevaCantidad = Math.max(0, Math.min(20, parseInt(input.value) + delta));
      input.value = nuevaCantidad;
      actualizarTotal();
    };

    // Funci√≥n para actualizar el multiplicador de tokens
    function actualizarMultiplicadorTokens() {
      fetch('/api/tokens/multiplicador')
        .then(res => res.json())
        .then(data => {
          multiplicadorActual = data.multiplicador;
          const valorElement = document.getElementById('multiplicador-valor');
          const tiempoElement = document.getElementById('multiplicador-tiempo');
          
          // Actualizar valor
          const porcentaje = data.porcentaje;
          valorElement.textContent = `${porcentaje >= 0 ? '+' : ''}${porcentaje}%`;
          
          // Actualizar clase CSS seg√∫n el valor
          valorElement.className = 'multiplicador-valor';
          if (porcentaje > 0) {
            valorElement.classList.add('positivo');
          } else if (porcentaje < 0) {
            valorElement.classList.add('negativo');
          } else {
            valorElement.classList.add('neutro');
          }
          
          // Actualizar tiempo restante
          tiempoElement.textContent = `Cambia en ${data.minutosHastaCambio} min`;
          
          // Actualizar preview si hay tokens seleccionados
          actualizarPreviewTokens();
        })
        .catch(() => {
          document.getElementById('multiplicador-valor').textContent = 'Error';
          document.getElementById('multiplicador-tiempo').textContent = '';
        });
    }
    
    // Funci√≥n para actualizar el estado del bonus
    function actualizarEstadoBonus() {
      fetch('/api/tokens/bonus')
        .then(res => res.json())
        .then(data => {
          const estadoElement = document.getElementById('bonus-estado');
          const btnActivar = document.getElementById('btn-activar-bonus');
          
          bonusActivo = data.activo;
          
          if (data.activo) {
            estadoElement.textContent = `ACTIVO +50% (${data.minutosRestantes} min)`;
            estadoElement.className = 'bonus-estado activo';
            btnActivar.style.display = 'none';
          } else if (!data.puedeActivar) {
            estadoElement.textContent = `Cooldown (${data.horasHastaCooldown}h)`;
            estadoElement.className = 'bonus-estado cooldown';
            btnActivar.style.display = 'none';
          } else {
            estadoElement.textContent = 'Disponible';
            estadoElement.className = 'bonus-estado inactivo';
            btnActivar.style.display = 'inline-block';
          }
          
          // Actualizar preview si hay tokens seleccionados
          actualizarPreviewTokens();
        })
        .catch(() => {
          document.getElementById('bonus-estado').textContent = 'Error';
          document.getElementById('bonus-estado').className = 'bonus-estado';
        });
    }
    
    // Funci√≥n para activar el bonus
    function activarBonus() {
      const btn = document.getElementById('btn-activar-bonus');
      btn.disabled = true;
      btn.textContent = 'Activando...';
      
      fetch('/api/tokens/bonus/activar', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      })
      .then(res => res.json())
      .then(result => {
        if (result.success) {
          actualizarEstadoBonus();
          mostrarMensaje('¬°Bonus activado! +50% de tokens durante 30 minutos.', 'green', false);
        } else {
          mostrarMensaje(`Error: ${result.error || 'No se pudo activar el bonus'}`, 'red', false);
          btn.disabled = false;
          btn.textContent = 'üöÄ Activar Bonus +50%';
        }
      })
      .catch(() => {
        mostrarMensaje('Error de conexi√≥n con el servidor.', 'red', false);
        btn.disabled = false;
        btn.textContent = 'üöÄ Activar Bonus +50%';
      });
    }
    
    // Funci√≥n para actualizar el preview de tokens
    function actualizarPreviewTokens() {
      const tokensInput = document.getElementById('tokens-cantidad');
      const cantidad = parseInt(tokensInput.value || 0);
      const previewElement = document.getElementById('tokens-preview');
      
      if (cantidad > 0) {
        const multiplicador = bonusActivo ? 1.5 : 1;
        const tokensFinales = Math.floor(cantidad * multiplicador);
        
        if (bonusActivo) {
          previewElement.textContent = `‚Üí Recibir√°s ${tokensFinales} tokens (¬°BONUS +50%!)`;
          previewElement.className = 'tokens-preview bonus';
        } else {
          previewElement.textContent = `‚Üí Recibir√°s ${tokensFinales} tokens`;
          previewElement.className = 'tokens-preview activo';
        }
      } else if (cantidad < 0) {
        previewElement.textContent = `‚Üí Se quitar√°n ${Math.abs(cantidad)} tokens`;
        previewElement.className = 'tokens-preview';
      } else {
        previewElement.textContent = '';
        previewElement.className = 'tokens-preview';
      }
    }
    
    // Funci√≥n para cambiar tokens con botones (actualizada)
    window.cambiarTokens = function(delta) {
      const input = document.getElementById('tokens-cantidad');
      const nuevaCantidad = Math.max(-100, Math.min(100, parseInt(input.value || 0) + delta));
      input.value = nuevaCantidad;
      actualizarPreviewTokens();
    };
    
    // Actualizar preview cuando cambia el input
    document.addEventListener('DOMContentLoaded', function() {
      const tokensInput = document.getElementById('tokens-cantidad');
      if (tokensInput) {
        tokensInput.addEventListener('input', actualizarPreviewTokens);
      }
    });
    
    // Confirmar compra
    window.confirmarCompra = function() {
      const ninoId = parseInt(document.getElementById('nino').value, 10);
      if (isNaN(ninoId)) {
        mostrarMensaje('Selecciona un ni√±o.', 'red', false);
        return;
      }
      
      const productosSeleccionados = [];
      let total = 0;
      
      document.querySelectorAll('.cantidad-input').forEach(input => {
        const cantidad = parseInt(input.value) || 0;
        if (cantidad > 0) {
          const precio = parseFloat(input.getAttribute('data-precio'));
          const productoId = input.id.replace('cantidad-', '');
          productosSeleccionados.push({ 
            id: productoId, 
            precio: precio, 
            cantidad: cantidad,
            subtotal: cantidad * precio
          });
          total += cantidad * precio;
        }
      });
      
      // Obtener tokens a a√±adir/quitar
      const tokensInput = document.getElementById('tokens-cantidad');
      const tokensA√±adir = parseInt(tokensInput.value || 0);
      
      // Verificar si hay productos o tokens para procesar
      if (total === 0 && tokensA√±adir === 0) {
        mostrarMensaje('Selecciona al menos un producto o a√±ade/quita tokens.', 'red', false);
        return;
      }

      // Verificar si supera el l√≠mite diario (solo si hay productos)
      if (total > 0 && total > LIMITE_DIARIO) {
        mostrarConfirmacionLimite(total, ninoId, productosSeleccionados, tokensA√±adir);
        return;
      }

      // Proceder con la compra normal
      procesarCompra(total, ninoId, productosSeleccionados, tokensA√±adir);
    };

    function mostrarConfirmacionLimite(total, ninoId, productos, tokensA√±adir) {
      const modal = document.createElement('div');
      modal.id = 'popup-modal';
      modal.innerHTML = `
        <div class="popup-content">
          <p><strong>¬°Atenci√≥n!</strong></p>
          <p>El total de <strong>${total.toFixed(2)}‚Ç¨</strong> supera la cota diaria recomendada de <strong>${LIMITE_DIARIO.toFixed(2)}‚Ç¨</strong>.</p>
          <p>¬øEst√°s seguro de que quieres continuar?</p>
          <div style="display: flex; gap: 10px; justify-content: center; margin-top: 15px;">
            <button id="confirmar-limite" style="background: #dc2626;">S√≠, continuar</button>
            <button id="cancelar-limite" style="background: #64748b;">Cancelar</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);

      document.getElementById('confirmar-limite').onclick = () => {
        modal.remove();
        procesarCompra(total, ninoId, productos, tokensA√±adir);
      };

      document.getElementById('cancelar-limite').onclick = () => {
        modal.remove();
      };

      modal.onclick = (e) => {
        if (e.target === modal) modal.remove();
      };
    }

    function procesarCompra(total, ninoId, productos, tokensA√±adir) {
      // Crear resumen del pedido
      let resumenProductos = productos.map(p => {
        const producto = productosDB.find(prod => prod.id == p.id);
        return `${producto.nombre} x${p.cantidad}`;
      }).join('<br>');

      // Obtener datos del ni√±o para el log
      const nino = ninosDB.find(n => n.id == ninoId);
      const productosTexto = productos.map(p => {
        const producto = productosDB.find(prod => prod.id == p.id);
        return `${producto.nombre} x${p.cantidad} (${p.subtotal.toFixed(2)}‚Ç¨)`;
      }).join(', ');

      // Operaciones en paralelo
      const operaciones = [];
      
      // Procesar compra si hay productos
      if (total > 0) {
        operaciones.push(
          fetch(`/api/ninos/${ninoId}/restar`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ cantidad: total })
          }).then(res => res.json())
        );
      }
      
      // Procesar tokens si hay tokens para a√±adir/quitar
      if (tokensA√±adir !== 0) {
        operaciones.push(
          fetch(`/api/ninos/${ninoId}/tokens`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ cantidad: tokensA√±adir })
          }).then(res => res.json())
        );
      }
      
      Promise.all(operaciones)
        .then(resultados => {
          // Resultado de compra (si hubo)
          const compraResult = total > 0 ? resultados[0] : null;
          
          // Resultado de tokens (si hubo)
          const tokensResult = tokensA√±adir !== 0 ? 
            (total > 0 ? resultados[1] : resultados[0]) : null;
          
          // Verificar si alguna operaci√≥n fall√≥
          if ((compraResult && !compraResult.success) || (tokensResult && !tokensResult.success)) {
            const error = (compraResult && !compraResult.success) ? compraResult.error : tokensResult.error;
            mostrarMensaje(`Error: ${error || 'No se pudo completar la operaci√≥n'}`, 'red', false);
            return;
          }
          
          // Si hay compra, registrar transacci√≥n
          if (total > 0) {
            fetch('/api/transacciones', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                nino_id: ninoId,
                nino_nombre: `${nino.nombre} ${nino.apellidos}`,
                productos: productosTexto,
                total: total
              })
            }).catch(() => console.error('No se pudo registrar la transacci√≥n'));
          }
          
          // Construir mensaje de √©xito
          let mensajeExito = '';
          
          if (total > 0) {
            mensajeExito += `Pedido confirmado.<br><strong>Productos:</strong><br>${resumenProductos}<br><strong>Total gastado:</strong> ${total.toFixed(2)}‚Ç¨<br><strong>Saldo restante:</strong> ${compraResult.nuevoSaldo.toFixed(2)}‚Ç¨<br>`;
          }
          
          if (tokensA√±adir !== 0) {
            mensajeExito += `${total > 0 ? '<br>' : ''}`;
            if (tokensA√±adir > 0) {
              const bonusInfo = tokensResult.bonusAplicado ? 
                `<br><small style="color: #f59e0b; font-weight: bold;">¬°BONUS +50% aplicado! (${tokensResult.tokenesOriginales} ‚Üí ${tokensResult.tokenesFinales})</small>` : '';
              mensajeExito += `<strong>Tokens a√±adidos:</strong> ${tokensResult.tokenesFinales || tokensA√±adir}${bonusInfo}<br><strong>Tokens totales:</strong> ${tokensResult.nuevosTokens}`;
            } else {
              mensajeExito += `<strong>Tokens quitados:</strong> ${Math.abs(tokensA√±adir)}<br><strong>Tokens totales:</strong> ${tokensResult.nuevosTokens}`;
            }
          }
          
          mostrarMensaje(mensajeExito, 'green', true);
        })
        .catch(() => mostrarMensaje('Error de conexi√≥n con el servidor.', 'red', false));
    }
    
    function mostrarMensaje(msg, color, reloadOnOk) {
      // Elimina cualquier popup-modal anterior
      const prev = document.getElementById('popup-modal');
      if (prev) prev.remove();

      const modal = document.createElement('div');
      modal.id = 'popup-modal';
      modal.style.position = 'fixed';
      modal.style.top = '0';
      modal.style.left = '0';
      modal.style.width = '100vw';
      modal.style.height = '100vh';
      modal.style.background = 'rgba(0,0,0,0.25)';
      modal.style.display = 'flex';
      modal.style.alignItems = 'center';
      modal.style.justifyContent = 'center';
      modal.style.zIndex = '30000';

      modal.innerHTML = `
        <div class="popup-content" style="background:white; border-radius:12px; padding:32px 28px; max-width:340px; width:90%; box-shadow:0 8px 32px rgba(67,56,202,0.18); text-align:center;">
          <p style="margin-bottom:18px; color:${color}; font-size:1.15em;">${msg}</p>
          ${reloadOnOk ? '<button id="popup-ok" style="background:linear-gradient(45deg,#4338ca,#6b21a8);color:white;border:none;border-radius:6px;padding:10px 28px;font-size:1em;font-weight:600;cursor:pointer;">OK</button>' : '<button id="popup-close" style="background:#64748b;color:white;border:none;border-radius:6px;padding:10px 28px;font-size:1em;font-weight:600;cursor:pointer;">Cerrar</button>'}
        </div>
      `;
      document.body.appendChild(modal);

      if (reloadOnOk) {
        document.getElementById('popup-ok').onclick = () => location.reload();
      } else {
        document.getElementById('popup-close').onclick = () => modal.remove();
      }

      modal.onclick = (e) => {
        if (e.target === modal) modal.remove();
      };
    }

    // Inicializar la aplicaci√≥n
    cargarConfiguracion();
    cargarProductos();
    
    // Inicializar multiplicador de tokens
    actualizarMultiplicadorTokens();
    intervaloMultiplicador = setInterval(actualizarMultiplicadorTokens, 30000); // Actualizar cada 30 segundos
    
    // Inicializar sistema de bonus
    actualizarEstadoBonus();
    intervaloBonus = setInterval(actualizarEstadoBonus, 15000); // Actualizar cada 15 segundos
    
    // Easter egg DKNS/Cuadrado: aparece al pulsar "C" en may√∫sculas (Shift+C)
    document.addEventListener('keydown', function(e) {
      if (e.key === 'C' && !e.ctrlKey && !e.altKey) {
        mostrarEasterEgg();
      }
    });
    function mostrarEasterEgg() {
      const egg = document.getElementById('easteregg-dkns');
      if (egg) egg.style.display = 'block';
    }
    // Tambi√©n puedes cerrar con Escape
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        const egg = document.getElementById('easteregg-dkns');
        if (egg) egg.style.display = 'none';
      }
    });
    
    function mostrarFormularioNino(nino = null) {
      const modal = document.createElement('div');
      modal.id = 'popup-modal';
      modal.innerHTML = `
        <div class="popup-content" style="max-width: 400px;">
          <h3>${nino ? 'Editar' : 'A√±adir'} Ni√±o</h3>
          <form id="form-nino">
            <div style="margin-bottom: 15px;">
              <label>Nombre:</label>
              <input type="text" id="nino-nombre" value="${nino ? nino.nombre : ''}" required>
            </div>
            <div style="margin-bottom: 15px;">
              <label>Apellidos:</label>
              <input type="text" id="nino-apellidos" value="${nino ? nino.apellidos : ''}" required>
            </div>
            <div style="margin-bottom: 15px;">
              <label>Grupo:</label>
              <input type="number" id="nino-grupo" value="${nino ? nino.grupo : ''}" min="1" required>
            </div>
            <div style="margin-bottom: 15px;">
              <label>Dinero (‚Ç¨):</label>
              <input type="number" id="nino-dinero" value="${nino ? nino.dinero : ''}" min="0" step="0.01" required>
            </div>
            <div style="margin-bottom: 15px;">
              <label>Tokens:</label>
              <input type="number" id="nino-tokens" value="${nino ? (nino.tokens || 0) : 0}" min="0" required>
            </div>
            <div style="display: flex; gap: 10px; justify-content: center;">
              <button type="submit" style="background: #4338ca;">Guardar</button>
              <button type="button" id="cancelar-nino" style="background: #64748b;">Cancelar</button>
            </div>
          </form>
        </div>
      `;
      document.body.appendChild(modal);

      document.getElementById('cancelar-nino').onclick = () => modal.remove();
      
      document.getElementById('form-nino').onsubmit = (e) => {
        e.preventDefault();
        
        const datos = {
          nombre: document.getElementById('nino-nombre').value,
          apellidos: document.getElementById('nino-apellidos').value,
          grupo: parseInt(document.getElementById('nino-grupo').value),
          dinero: parseFloat(document.getElementById('nino-dinero').value),
          tokens: parseInt(document.getElementById('nino-tokens').value)
        };
        
        const url = nino ? `/api/ninos/${nino.id}` : '/api/ninos';
        const method = nino ? 'PUT' : 'POST';
        
        fetch(url, {
          method: method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(datos)
        })
        .then(res => res.json())
        .then(result => {
          if (result.success) {
            modal.remove();
            cargarNinos();
            mostrarMensaje(nino ? 'Ni√±o actualizado correctamente' : 'Ni√±o a√±adido correctamente', 'green', false);
          } else {
            mostrarMensaje(`Error: ${result.error}`, 'red', false);
          }
        })
        .catch(() => mostrarMensaje('Error de conexi√≥n', 'red', false));
      };
    }
    
    function cargarNinos() {
      fetch('/api/ninos')
        .then(res => res.json())
        .then(ninos => {
          const tbody = document.getElementById('tabla-ninos-body');
          tbody.innerHTML = '';
          
          ninos.forEach(nino => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${nino.nombre}</td>
              <td>${nino.apellidos}</td>
              <td>${nino.grupo}</td>
              <td>${nino.dinero.toFixed(2)}‚Ç¨</td>
              <td>${nino.tokens || 0}</td>
              <td>
                <button onclick="mostrarFormularioNino(${JSON.stringify(nino).replace(/"/g, '&quot;')})" class="btn-editar">Editar</button>
                <button onclick="eliminarNino(${nino.id})" class="btn-eliminar">Eliminar</button>
              </td>
            `;
            tbody.appendChild(tr);
          });
        });
    }
  </script>
</body>
</html>