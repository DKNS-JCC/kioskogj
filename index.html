<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Kiosko Campamento</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="kiosk-container">
    <h1>üè™ Kiosko GJ</h1>
    <div class="main-actions-bar main-actions-bar-right">
      <button onclick="window.location.href='stats.html'" class="btn-stats-top" title="Ver estad√≠sticas">üìä</button>
      <button onclick="window.location.href='setup.html'" class="btn-settings-corner" title="Ajustes">‚öôÔ∏è</button>
    </div>

    <div class="user-selection">
      <div class="select-group">
        <label for="grupo">üë• Grupo</label>
        <select id="grupo">
          <option value="">Selecciona grupo</option>
        </select>
      </div>
      <div class="select-group">
        <label for="nino">üë§ Ni√±o</label>
        <select id="nino" disabled>
          <option value="">Selecciona ni√±o</option>
        </select>
      </div>
    </div>

    <!-- NUEVO: Info de saldo y compra del ni√±o -->
    <div id="info-nino" class="info-nino-card"></div>

    <div class="order-section">
      <h2>üõí Pedido</h2>
      <div id="productos"></div>
    </div>

    <div class="total-section">
      <p>Total: <span id="total">0.00</span> ‚Ç¨</p>
    </div>

    <div class="button-group">
      <button onclick="confirmarCompra()" class="btn-confirm">‚úÖ Confirmar pedido</button>
    </div>

    <div id="mensaje"></div>
  </div>
  <!-- Bot√≥n de ayuda flotante y barra de acciones vertical -->
  <div class="floating-actions-vertical">
    <button id="btn-ayuda" class="btn-ayuda-rect" onclick="iniciarTutorial()" title="Ayuda">?</button>
    <button onclick="window.location.href='stats.html'" class="btn-stats-vertical" title="Ver estad√≠sticas">üìä</button>
    <button onclick="window.location.href='setup.html'" class="btn-settings-vertical" title="Ajustes">‚öôÔ∏è</button>
  </div>
  <script>
    let productosDB = [];
    let LIMITE_DIARIO = 2.50; // Valor por defecto
    
    // Sistema de tutorial guiado
    const pasosTutorial = [
      {
        elemento: '.user-selection',
        titulo: 'Selecci√≥n de usuario',
        mensaje: 'Aqu√≠ puedes seleccionar primero un grupo y luego un ni√±o para realizar una compra.',
        posicion: 'abajo'
      },
      {
        elemento: '#productos',
        titulo: 'Productos disponibles',
        mensaje: 'Puedes hacer clic en cualquier producto para a√±adir uno a tu pedido. Tambi√©n puedes usar los botones + y - para ajustar la cantidad.',
        posicion: 'arriba'
      },
      {
        elemento: '.total-section',
        titulo: 'Total del pedido',
        mensaje: 'Aqu√≠ ver√°s el total a pagar. Si supera el l√≠mite diario recomendado, se mostrar√° en rojo.',
        posicion: 'arriba'
      },
      {
        elemento: '.btn-confirm',
        titulo: 'Confirmar pedido',
        mensaje: 'Una vez seleccionados los productos, haz clic aqu√≠ para finalizar la compra.',
        posicion: 'izquierda'
      },
      {
        elemento: '.btn-settings-corner',
        titulo: 'Ajustes',
        mensaje: 'Accede a la pantalla de administraci√≥n para gestionar ni√±os y productos.',
        posicion: 'izquierda'
      }
    ];
    
    let pasoActual = 0;
    let popupTutorial = null;
    
    function iniciarTutorial() {
      pasoActual = 0;
      mostrarPasoTutorial();
      
      // Ocultar temporalmente el bot√≥n de ayuda durante el tutorial
      document.getElementById('btn-ayuda').style.display = 'none';
    }
    
    function mostrarPasoTutorial() {
      // Eliminar popup anterior si existe
      if (popupTutorial) {
        popupTutorial.remove();
      }
      
      if (pasoActual >= pasosTutorial.length) {
        finalizarTutorial();
        return;
      }
      
      const paso = pasosTutorial[pasoActual];
      const elemento = document.querySelector(paso.elemento);
      
      if (!elemento) {
        pasoActual++;
        mostrarPasoTutorial();
        return;
      }
      
      // Crear popup
      popupTutorial = document.createElement('div');
      popupTutorial.className = `tutorial-popup tutorial-${paso.posicion}`;
      popupTutorial.innerHTML = `
        <div class="tutorial-header">
          <span class="tutorial-numero">${pasoActual + 1}/${pasosTutorial.length}</span>
          <h3>${paso.titulo}</h3>
          <button class="tutorial-cerrar" onclick="finalizarTutorial()">√ó</button>
        </div>
        <div class="tutorial-contenido">
          <p>${paso.mensaje}</p>
        </div>
        <div class="tutorial-botones">
          ${pasoActual > 0 ? `<button onclick="pasoPrevio()">¬´ Anterior</button>` : ''}
          <button onclick="pasoSiguiente()">${pasoActual < pasosTutorial.length - 1 ? 'Siguiente ¬ª' : 'Finalizar'}</button>
        </div>
      `;
      
      document.body.appendChild(popupTutorial);
      
      // Posicionar popup
      posicionarPopup(popupTutorial, elemento, paso.posicion);
      
      // Destacar el elemento actual
      elemento.classList.add('tutorial-destacado');
    }
    
    function posicionarPopup(popup, elemento, posicion) {
      const rect = elemento.getBoundingClientRect();
      
      switch(posicion) {
        case 'arriba':
          popup.style.left = `${rect.left + rect.width/2}px`;
          popup.style.top = `${rect.top - 10}px`;
          break;
        case 'abajo':
          popup.style.left = `${rect.left + rect.width/2}px`;
          popup.style.top = `${rect.bottom + 10}px`;
          break;
        case 'izquierda':
          popup.style.left = `${rect.left - 10}px`;
          popup.style.top = `${rect.top + rect.height/2}px`;
          break;
        case 'derecha':
          popup.style.left = `${rect.right + 10}px`;
          popup.style.top = `${rect.top + rect.height/2}px`;
          break;
      }
    }
    
    function pasoSiguiente() {
      // Quitar destacado del elemento actual
      const pasoActualObj = pasosTutorial[pasoActual];
      const elementoActual = document.querySelector(pasoActualObj.elemento);
      if (elementoActual) {
        elementoActual.classList.remove('tutorial-destacado');
      }
      
      pasoActual++;
      mostrarPasoTutorial();
    }
    
    function pasoPrevio() {
      // Quitar destacado del elemento actual
      const pasoActualObj = pasosTutorial[pasoActual];
      const elementoActual = document.querySelector(pasoActualObj.elemento);
      if (elementoActual) {
        elementoActual.classList.remove('tutorial-destacado');
      }
      
      pasoActual--;
      mostrarPasoTutorial();
    }
    
    function finalizarTutorial() {
      if (popupTutorial) {
        popupTutorial.remove();
        popupTutorial = null;
      }
      
      // Quitar destacado de todos los elementos
      document.querySelectorAll('.tutorial-destacado').forEach(el => {
        el.classList.remove('tutorial-destacado');
      });
      
      // Mostrar nuevamente el bot√≥n de ayuda
      document.getElementById('btn-ayuda').style.display = 'block';
    }

    // Cargar configuraci√≥n al inicio
    function cargarConfiguracion() {
      fetch('/api/configuracion')
        .then(res => res.json())
        .then(config => {
          LIMITE_DIARIO = config.cotaDiaria || 2.50;
        })
        .catch(() => {
          // Si no hay configuraci√≥n, usar valor por defecto
          LIMITE_DIARIO = 2.50;
        });
    }

    // Cargar productos desde el backend
    function cargarProductos() {
      fetch('/api/productos')
        .then(res => res.json())
        .then(productos => {
          productosDB = productos;
          const productosContainer = document.getElementById('productos');
          productosContainer.innerHTML = '';
          productos.forEach(producto => {
            const label = document.createElement('label');
            label.className = 'producto-card-clickable';
            
            // Create the HTML content
            label.innerHTML = `
              <div class="producto-info">
                <span class="producto-nombre">${producto.nombre}</span>
                <span class="price">${producto.precio.toFixed(2)}‚Ç¨</span>
              </div>
              <div class="cantidad-controls">
                <button type="button" class="btn-cantidad" id="btn-minus-${producto.id}">-</button>
                <input type="number" class="cantidad-input" id="cantidad-${producto.id}" 
                       value="0" min="0" max="20" data-precio="${producto.precio}">
                <button type="button" class="btn-cantidad" id="btn-plus-${producto.id}">+</button>
              </div>
            `;
            
            productosContainer.appendChild(label);
            
            // Add click handlers after the element is in the DOM
            document.getElementById(`btn-minus-${producto.id}`).onclick = (e) => {
              e.stopPropagation();
              cambiarCantidad(producto.id, -1);
            };
            
            document.getElementById(`btn-plus-${producto.id}`).onclick = (e) => {
              e.stopPropagation();
              cambiarCantidad(producto.id, 1);
            };
            
            document.getElementById(`cantidad-${producto.id}`).onchange = (e) => {
              e.stopPropagation();
              actualizarTotal();
            };
            
            // Add click handler to the label itself
            label.onclick = function() {
              // Skip if clicked on a button or input
              if (event.target.tagName === 'BUTTON' || event.target.tagName === 'INPUT') {
                return;
              }
              
              // Add product to cart
              cambiarCantidad(producto.id, 1);
              
              // Visual feedback
              this.classList.add('clicked');
              setTimeout(() => this.classList.remove('clicked'), 200);
            };
          });
        });
    }

    // Cargar grupos √∫nicos desde la base de datos
    let ninosDB = [];
    fetch('/api/ninos')
      .then(res => res.json())
      .then(ninos => {
        ninosDB = ninos;
        const grupos = [...new Set(ninos.map(n => n.grupo))].sort((a, b) => a - b);
        const grupoSelect = document.getElementById('grupo');
        grupos.forEach(grupo => {
          const opt = document.createElement('option');
          opt.value = grupo;
          opt.textContent = grupo;
          grupoSelect.appendChild(opt);
        });
      });

    // Mostrar info de saldo y compra al seleccionar ni√±o
    document.getElementById('nino').addEventListener('change', function() {
      const ninoId = this.value;
      const infoDiv = document.getElementById('info-nino');
      infoDiv.textContent = '';
      infoDiv.className = 'info-nino-card'; // reset classes
      if (!ninoId) {
        infoDiv.textContent = '';
        return;
      }
      // Consultar saldo y si ya ha comprado hoy
      fetch(`/api/ninos/${ninoId}/info`)
        .then(res => {
          if (!res.ok) throw new Error('No se pudo consultar el ni√±o');
          return res.json();
        })
        .then(data => {
          let saldo = typeof data.saldo === 'number' ? data.saldo.toFixed(2) : '--';
          let comprado = data.compradoHoy ? 'S√≠' : 'No';
          let color = data.compradoHoy ? '#dc2626' : '#10b981';
          let icon = data.compradoHoy
            ? '<span class="info-nino-icon" style="background:#fee2e2;color:#dc2626;">&#9888;</span>'
            : '<span class="info-nino-icon" style="background:#d1fae5;color:#10b981;">&#10003;</span>';
          infoDiv.innerHTML = `
            <div class="info-nino-flex">
              <div>
                <span class="info-nino-label">üí∞ Saldo:</span>
                <span class="info-nino-value" style="color:#4338ca">${saldo}‚Ç¨</span>
              </div>
              <div>
                <span class="info-nino-label">üóìÔ∏è ¬øHa comprado hoy?:</span>
                <span class="info-nino-value" style="color:${color};font-weight:700">${comprado}</span>
                ${icon}
              </div>
            </div>
          `;
        })
        .catch(() => {
          infoDiv.innerHTML = '<div class="info-nino-error">‚ö†Ô∏è No se pudo consultar el ni√±o seleccionado.</div>';
        });
    });

    document.getElementById('grupo').addEventListener('change', function() {
      const grupo = this.value;
      const ninoSelect = document.getElementById('nino');
      ninoSelect.innerHTML = '<option value="">Selecciona ni√±o</option>';
      if (!grupo) {
        ninoSelect.disabled = true;
        return;
      }
      const filtrados = ninosDB
        .filter(n => n.grupo.toString() === grupo)
        .sort((a, b) => (a.nombre + ' ' + a.apellidos).localeCompare(b.nombre + ' ' + b.apellidos));
      filtrados.forEach(nino => {
        const opt = document.createElement('option');
        opt.value = nino.id;
        opt.textContent = nino.nombre + ' ' + nino.apellidos;
        ninoSelect.appendChild(opt);
      });
      ninoSelect.disabled = false;
    });

    // Funci√≥n para cambiar cantidad con botones
    window.cambiarCantidad = function(productoId, delta) {
      const input = document.getElementById(`cantidad-${productoId}`);
      const nuevaCantidad = Math.max(0, Math.min(20, parseInt(input.value) + delta));
      input.value = nuevaCantidad;
      actualizarTotal();
    };

    // Actualizar total cuando cambia cualquier cantidad
    function actualizarTotal() {
      let total = 0;
      document.querySelectorAll('.cantidad-input').forEach(input => {
        const cantidad = parseInt(input.value) || 0;
        const precio = parseFloat(input.getAttribute('data-precio'));
        total += cantidad * precio;
      });
      
      const totalElement = document.getElementById('total');
      const totalSection = document.querySelector('.total-section');
      
      totalElement.textContent = total.toFixed(2);
      
      // Aplicar estilos seg√∫n si supera el l√≠mite
      if (total > LIMITE_DIARIO) {
        totalSection.classList.add('limite-superado');
      } else {
        totalSection.classList.remove('limite-superado');
      }
    }

    // Confirmar compra
    window.confirmarCompra = function() {
      const ninoId = parseInt(document.getElementById('nino').value, 10);
      if (isNaN(ninoId)) {
        mostrarMensaje('Selecciona un ni√±o.', 'red', false);
        return;
      }
      
      const productosSeleccionados = [];
      let total = 0;
      
      document.querySelectorAll('.cantidad-input').forEach(input => {
        const cantidad = parseInt(input.value) || 0;
        if (cantidad > 0) {
          const precio = parseFloat(input.getAttribute('data-precio'));
          const productoId = input.id.replace('cantidad-', '');
          productosSeleccionados.push({ 
            id: productoId, 
            precio: precio, 
            cantidad: cantidad,
            subtotal: cantidad * precio
          });
          total += cantidad * precio;
        }
      });
      
      if (total === 0) {
        mostrarMensaje('Selecciona al menos un producto.', 'red', false);
        return;
      }

      // Verificar si supera el l√≠mite diario
      if (total > LIMITE_DIARIO) {
        mostrarConfirmacionLimite(total, ninoId, productosSeleccionados);
        return;
      }

      // Proceder con la compra normal
      procesarCompra(total, ninoId, productosSeleccionados);
    };

    function mostrarConfirmacionLimite(total, ninoId, productos) {
      const modal = document.createElement('div');
      modal.id = 'popup-modal';
      modal.innerHTML = `
        <div class="popup-content">
          <p><strong>¬°Atenci√≥n!</strong></p>
          <p>El total de <strong>${total.toFixed(2)}‚Ç¨</strong> supera la cota diaria recomendada de <strong>${LIMITE_DIARIO.toFixed(2)}‚Ç¨</strong>.</p>
          <p>¬øEst√°s seguro de que quieres continuar?</p>
          <div style="display: flex; gap: 10px; justify-content: center; margin-top: 15px;">
            <button id="confirmar-limite" style="background: #dc2626;">S√≠, continuar</button>
            <button id="cancelar-limite" style="background: #64748b;">Cancelar</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);

      document.getElementById('confirmar-limite').onclick = () => {
        modal.remove();
        procesarCompra(total, ninoId, productos);
      };

      document.getElementById('cancelar-limite').onclick = () => {
        modal.remove();
      };

      modal.onclick = (e) => {
        if (e.target === modal) modal.remove();
      };
    }

    function procesarCompra(total, ninoId, productos) {
      // Crear resumen del pedido
      let resumenProductos = productos.map(p => {
        const producto = productosDB.find(prod => prod.id == p.id);
        return `${producto.nombre} x${p.cantidad}`;
      }).join('<br>');

      // Obtener datos del ni√±o para el log
      const nino = ninosDB.find(n => n.id == ninoId);
      const productosTexto = productos.map(p => {
        const producto = productosDB.find(prod => prod.id == p.id);
        return `${producto.nombre} x${p.cantidad} (${p.subtotal.toFixed(2)}‚Ç¨)`;
      }).join(', ');

      // Restar saldo en el backend
      fetch(`/api/ninos/${ninoId}/restar`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ cantidad: total })
      })
      .then(res => res.json())
      .then(resp => {
        if (resp.success) {
          // Registrar la transacci√≥n
          fetch('/api/transacciones', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              nino_id: ninoId,
              nino_nombre: `${nino.nombre} ${nino.apellidos}`,
              productos: productosTexto,
              total: total
            })
          })
          .then(() => {
            mostrarMensaje(
              `Pedido confirmado.<br><strong>Productos:</strong><br>${resumenProductos}<br><strong>Total gastado:</strong> ${total.toFixed(2)}‚Ç¨<br><strong>Saldo restante:</strong> ${resp.nuevoSaldo.toFixed(2)}‚Ç¨`,
              'green',
              true
            );
          })
          .catch(() => {
            // Mostrar mensaje aunque falle el log (la compra ya se proces√≥)
            mostrarMensaje(
              `Pedido confirmado.<br><strong>Productos:</strong><br>${resumenProductos}<br><strong>Total gastado:</strong> ${total.toFixed(2)}‚Ç¨<br><strong>Saldo restante:</strong> ${resp.nuevoSaldo.toFixed(2)}‚Ç¨`,
              'green',
              true
            );
          });
        } else {
          mostrarMensaje(`Error: ${resp.error || 'No se pudo procesar el pedido'}`, 'red', false);
        }
      })
      .catch(() => mostrarMensaje('Error de conexi√≥n con el servidor.', 'red', false));
    }

    function mostrarMensaje(msg, color, reloadOnOk) {
      const modal = document.createElement('div');
      modal.id = 'popup-modal';
      modal.innerHTML = `
        <div class="popup-content">
          <p>${msg}</p>
          ${reloadOnOk ? '<button id="popup-ok">OK</button>' : ''}
        </div>
      `;
      document.body.appendChild(modal);

      if (reloadOnOk) {
        document.getElementById('popup-ok').onclick = () => location.reload();
      }

      modal.onclick = (e) => {
        if (e.target === modal) modal.remove();
      };
    }

    // Inicializar la aplicaci√≥n
    cargarConfiguracion();
    cargarProductos();
  </script>
</body>
</html>
</html>
