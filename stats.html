<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Estad√≠sticas y Log - Kiosko Campamento</title>
  <link rel="stylesheet" href="styles.css">
  <!-- A√±adir Chart.js para los gr√°ficos -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="stats-container">
    <!-- Cabecera -->
    <h1 style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
      <button onclick="window.location.href='index.html'" class="btn-back" style="margin:0 10px 0 0;min-width:unset;padding:10px 18px;font-size:1.1rem;">‚Üê Volver</button>
      <span style="flex:1;text-align:center;">Estad√≠sticas y Log de Compras</span>
      <span style="width:110px;"></span>
    </h1>
    
    <!-- SECCI√ìN 1: Resumen de Estad√≠sticas -->
    <section class="stats-section">
      <h2 class="section-title">üìà Resumen de Actividad</h2>
      <div class="stats-overview">
        <div class="stat-card">
          <div class="stat-icon" style="background: linear-gradient(45deg, #4338ca, #6b21a8);">üí∞</div>
          <div class="stat-info">
            <h3>Total Ventas</h3>
            <p class="stat-number" id="total-ventas">0‚Ç¨</p>
            <span class="stat-subtitle" id="total-transacciones">0 transacciones</span>
          </div>
        </div>
        
        <div class="stat-card">
          <div class="stat-icon" style="background: linear-gradient(45deg, #10b981, #059669);">üìÖ</div>
          <div class="stat-info">
            <h3>Ventas Hoy</h3>
            <p class="stat-number" id="ventas-hoy">0‚Ç¨</p>
            <span class="stat-subtitle" id="transacciones-hoy">0 transacciones</span>
          </div>
        </div>
        
        <div class="stat-card">
          <div class="stat-icon" style="background: linear-gradient(45deg, #f59e0b, #d97706);">üëë</div>
          <div class="stat-info">
            <h3>Top Cliente</h3>
            <p class="stat-number" id="top-cliente">-</p>
            <span class="stat-subtitle" id="top-cliente-amount">0‚Ç¨ gastado</span>
          </div>
        </div>
        
        <div class="stat-card">
          <div class="stat-icon" style="background: linear-gradient(45deg, #ef4444, #b91c1c);">üëø</div>
          <div class="stat-info">
            <h3>Top m√°s castigado</h3>
            <p class="stat-number" id="top-castigado">-</p>
            <span class="stat-subtitle" id="top-castigado-veces">0 veces</span>
          </div>
        </div>
      </div>
    </section>

    <!-- NUEVA SECCI√ìN: Estad√≠sticas de Tokens -->
    <section class="stats-section">
      <h2 class="section-title">ü™ô Estad√≠sticas de Tokens</h2>
      <div class="stats-overview">
        <div class="stat-card">
          <div class="stat-icon" style="background: linear-gradient(45deg, #ca8a04, #eab308);">üèÜ</div>
          <div class="stat-info">
            <h3>Total Tokens</h3>
            <p class="stat-number" id="total-tokens">0</p>
            <span class="stat-subtitle">En todo el campamento</span>
          </div>
        </div>
        
        <div class="stat-card">
          <div class="stat-icon" style="background: linear-gradient(45deg, #ca8a04, #eab308);">üëë</div>
          <div class="stat-info">
            <h3>Top Tokens Individual</h3>
            <p class="stat-number" id="top-tokens-nino">-</p>
            <span class="stat-subtitle" id="top-tokens-nino-cantidad">0 tokens</span>
          </div>
        </div>
      </div>
      
      <!-- Tokens por grupo -->
      <div style="padding: 0 24px 24px 24px;">
        <h3 style="margin: 10px 0 20px; color: #ca8a04; text-align: center;">Tokens por Grupo</h3>
        <div id="tokens-por-grupo" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px;"></div>
      </div>
      
      <!-- Top aportadores de tokens -->
      <div style="margin: 30px 24px;">
        <h3 style="margin-bottom: 16px; color: #ca8a04; text-align: center;">Top 5 Aportadores de Tokens</h3>
        <div class="transactions-list" id="tokens-ranking"></div>
      </div>
    </section>

    <!-- SECCI√ìN 2: An√°lisis Visual - Simplificado para campamento corto -->
    <section class="charts-section">
      <h2 class="section-title">üìä Actividad del Campamento</h2>
      <div class="charts-grid">
        <div class="chart-card">
          <h3>Consumo diario (√∫ltimos 10 d√≠as)</h3>
          <div class="chart-container">
            <canvas id="ventas-diarias-chart"></canvas>
          </div>
        </div>
        
        <div class="chart-card">
          <h3>Distribuci√≥n por grupo</h3>
          <div class="chart-container">
            <canvas id="grupos-chart"></canvas>
          </div>
        </div>
      </div>
      
      <!-- Estad√≠sticas adicionales para campamento corto -->
      <div class="camp-stats-grid">
        <div class="camp-stat-card">
          <h3>D√≠a m√°s activo</h3>
          <div id="dia-mas-activo" class="camp-stat-value">-</div>
        </div>
        
        <div class="camp-stat-card">
          <h3>Producto m√°s vendido</h3>
          <div id="producto-mas-vendido" class="camp-stat-value">-</div>
        </div>
        
        <div class="camp-stat-card">
          <h3>Transacciones totales</h3>
          <div id="total-transacciones-camp" class="camp-stat-value">0</div>
        </div>
      </div>
    </section>

    <!-- SECCI√ìN 3: Filtros de B√∫squeda -->
    <section class="filters-section">
      <h2 class="section-title">üîç Filtros de B√∫squeda</h2>
      <div class="filters-panel">
        <div class="filters-grid">
          <div class="filter-column">
            <h3 class="filter-column-title">Periodo</h3>
            <div class="filter-group">
              <label>Desde:</label>
              <input type="date" id="fecha-inicio" class="filter-input">
            </div>
            
            <div class="filter-group">
              <label>Hasta:</label>
              <input type="date" id="fecha-fin" class="filter-input">
            </div>
          </div>
          
          <div class="filter-column">
            <h3 class="filter-column-title">Cliente</h3>
            <div class="filter-group">
              <label>Ni√±o:</label>
              <select id="filtro-nino" class="filter-input">
                <option value="">Todos los ni√±os</option>
              </select>
            </div>
            
            <div class="filter-group">
              <label>Grupo:</label>
              <select id="filtro-grupo" class="filter-input">
                <option value="">Todos los grupos</option>
              </select>
            </div>
          </div>
          
          <div class="filter-column">
            <h3 class="filter-column-title">Productos</h3>
            <div class="filter-group">
              <label>Buscar t√©rmino:</label>
              <input type="text" id="busqueda-productos" class="filter-input" placeholder="Ej: Coca Cola, Helado...">
            </div>
          </div>
        </div>
        
        <div class="filter-actions">
          <button id="aplicar-filtros" class="btn-filter">
            <span class="filter-btn-icon">üîç</span> Aplicar Filtros
          </button>
          <button id="limpiar-filtros" class="btn-clear">
            <span class="filter-btn-icon">üóëÔ∏è</span> Limpiar
          </button>
          <button id="exportar-excel" class="btn-export">
            <span class="filter-btn-icon">üìä</span> Exportar a Excel
          </button>
        </div>
      </div>
    </section>

    <!-- SECCI√ìN 4: Historial de Transacciones -->
    <section class="transactions-section">
      <h2 class="section-title">üìù Historial de Compras</h2>
      <div class="results-header">
        <div class="results-info">
          <span id="total-resultados">0 resultados</span>
        </div>
      </div>
      
      <div id="transacciones-lista" class="transactions-list"></div>
      
      <!-- Paginaci√≥n -->
      <div class="pagination" id="pagination">
        <button id="prev-page" class="btn-page">‚Üê Anterior</button>
        <span id="page-info">P√°gina 1 de 1</span>
        <button id="next-page" class="btn-page">Siguiente ‚Üí</button>
      </div>
    </section>

    <!-- SECCI√ìN 5: Acciones finales -->
    <section class="stats-actions-section">
      <div class="stats-actions">
        <button onclick="window.location.href='index.html'" class="btn-back">‚Üê Volver al kiosko</button>
        <button onclick="window.location.href='setup.html'" class="btn-settings">‚öôÔ∏è Ajustes</button>
      </div>
    </section>
  </div>

  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <script>
    let todasLasTransacciones = [];
    let transaccionesFiltradas = [];
    let paginaActual = 1;
    const transaccionesPorPagina = 20;
    let chartVentasDiarias, chartGrupos;

    // Cargar estad√≠sticas
    function cargarEstadisticas() {
      fetch('/api/estadisticas')
        .then(res => res.json())
        .then(stats => {
          // Total ventas
          const totalVentas = stats.totalVentas[0] || { count: 0, sum: 0 };
          document.getElementById('total-ventas').textContent = `${(totalVentas.sum || 0).toFixed(2)}‚Ç¨`;
          document.getElementById('total-transacciones').textContent = `${totalVentas.count} transacciones`;
          document.getElementById('total-transacciones-camp').textContent = totalVentas.count;
          
          // Ventas hoy
          const ventasHoy = stats.ventasHoy[0] || { count: 0, sum: 0 };
          document.getElementById('ventas-hoy').textContent = `${(ventasHoy.sum || 0).toFixed(2)}‚Ç¨`;
          document.getElementById('transacciones-hoy').textContent = `${ventasHoy.count} transacciones`;
          
          // Top cliente
          const topCliente = stats.topNinos[0];
          if (topCliente) {
            document.getElementById('top-cliente').textContent = topCliente.nino_nombre;
            document.getElementById('top-cliente-amount').textContent = `${topCliente.gastado.toFixed(2)}‚Ç¨ gastado`;
          }

          // Top castigado (nuevo)
          fetch('/api/ninos')
            .then(res => res.json())
            .then(ninos => {
              fetch('/api/castigos-historico')
                .then(res => res.json())
                .then(hist => {
                  // hist: { nino_id: veces, ... }
                  let max = 0, topId = null;
                  for (const [id, veces] of Object.entries(hist)) {
                    if (veces > max) {
                      max = veces;
                      topId = id;
                    }
                  }
                  if (topId && ninos.length > 0) {
                    const nino = ninos.find(n => n.id == topId);
                    document.getElementById('top-castigado').textContent = nino ? `${nino.nombre} ${nino.apellidos}` : `ID ${topId}`;
                    document.getElementById('top-castigado-veces').textContent = `${max} veces`;
                  } else {
                    document.getElementById('top-castigado').textContent = '-';
                    document.getElementById('top-castigado-veces').textContent = '0 veces';
                  }
                });
            });

          // Generar gr√°ficos para campamento corto
          if (stats.ventasPorDia && stats.ventasPorDia.length > 0) {
            generarGraficoVentasDiarias(stats.ventasPorDia);
          }
          
          // Analizar productos vendidos
          fetch('/api/transacciones')
            .then(res => res.json())
            .then(transacciones => {
              // Calcular producto m√°s vendido
              const productosConteo = {};
              
              transacciones.forEach(t => {
                const productosArray = t.productos.split(',');
                productosArray.forEach(prod => {
                  const match = prod.trim().match(/(.+) x(\d+)/);
                  if (match) {
                    const nombre = match[1].trim();
                    const cantidad = parseInt(match[2], 10);
                    if (!productosConteo[nombre]) productosConteo[nombre] = 0;
                    productosConteo[nombre] += cantidad;
                  }
                });
              });
              
              // Encontrar el producto m√°s vendido
              let productoMasVendido = { nombre: '-', cantidad: 0 };
              for (const [nombre, cantidad] of Object.entries(productosConteo)) {
                if (cantidad > productoMasVendido.cantidad) {
                  productoMasVendido = { nombre, cantidad };
                }
              }
              
              // Actualizar en la interfaz
              document.getElementById('producto-mas-vendido').innerHTML = `
                <span class="camp-stat-product">${productoMasVendido.nombre}</span>
                <span class="camp-stat-detail">${productoMasVendido.cantidad} unidades</span>
              `;
              
              generarGraficoGrupos(transacciones);
            })
            .catch(err => console.error('Error cargando datos para gr√°ficos:', err));
        })
        .catch(err => console.error('Error cargando estad√≠sticas:', err));
    }
    
    // Generar gr√°fico de ventas diarias simplificado para campamento corto
    function generarGraficoVentasDiarias(ventasPorDia) {
      const dias = [];
      const ventas = [];
      const compras = [];
      
      // Ordenar por fecha ascendente
      ventasPorDia.sort((a, b) => new Date(a.fecha) - new Date(b.fecha));
      
      // Limitar a los √∫ltimos 10 d√≠as si hay m√°s datos
      const ultimosDias = ventasPorDia.slice(-10);
      
      let maxVentasDia = { fecha: '', total: 0, compras: 0 };
      
      ultimosDias.forEach(dia => {
        // Formatear fecha a formato legible
        const fecha = new Date(dia.fecha);
        const fechaFormateada = fecha.toLocaleDateString('es-ES', { weekday: 'short', day: '2-digit', month: '2-digit' });
        dias.push(fechaFormateada);
        ventas.push(dia.total || 0);
        compras.push(dia.compras || 0);
        
        // Registrar el d√≠a con m√°s ventas
        if (dia.total > maxVentasDia.total) {
          maxVentasDia = {
            fecha: fechaFormateada,
            total: dia.total,
            compras: dia.compras
          };
        }
      });
      
      // Actualizar estad√≠stica de d√≠a m√°s activo
      if (maxVentasDia.fecha) {
        document.getElementById('dia-mas-activo').innerHTML = `
          <span class="camp-stat-day">${maxVentasDia.fecha}</span>
          <span class="camp-stat-detail">${maxVentasDia.total.toFixed(2)}‚Ç¨ (${maxVentasDia.compras} trans.)</span>
        `;
      }
      
      const ctx = document.getElementById('ventas-diarias-chart').getContext('2d');
      
      if (chartVentasDiarias) {
        chartVentasDiarias.destroy();
      }
      
      chartVentasDiarias = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: dias,
          datasets: [
            {
              label: 'Ventas (‚Ç¨)',
              data: ventas,
              backgroundColor: 'rgba(67, 56, 202, 0.7)',
              borderColor: 'rgba(67, 56, 202, 1)',
              borderWidth: 1
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false,
            },
            tooltip: {
              callbacks: {
                footer: function(tooltipItems) {
                  const idx = tooltipItems[0].dataIndex;
                  return `${compras[idx]} transacciones`;
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Ventas (‚Ç¨)'
              }
            }
          }
        }
      });
    }
    
    // Generar gr√°fico de distribuci√≥n por grupos
    function generarGraficoGrupos(transacciones) {
      const grupos = {};
      
      transacciones.forEach(t => {
        const grupo = t.grupo || 'Sin grupo';
        if (!grupos[grupo]) grupos[grupo] = 0;
        grupos[grupo] += t.total;
      });
      
      const labels = Object.keys(grupos).sort((a, b) => a - b).map(g => `Grupo ${g}`);
      const data = labels.map(l => grupos[l.replace('Grupo ', '')]);
      
      const ctx = document.getElementById('grupos-chart').getContext('2d');
      
      if (chartGrupos) {
        chartGrupos.destroy();
      }
      
      chartGrupos = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: labels,
          datasets: [{
            data: data,
            backgroundColor: [
              'rgba(99, 102, 241, 0.7)',
              'rgba(16, 185, 129, 0.7)',
              'rgba(245, 158, 11, 0.7)',
              'rgba(236, 72, 153, 0.7)',
              'rgba(14, 165, 233, 0.7)',
              'rgba(139, 92, 246, 0.7)',
              'rgba(234, 88, 12, 0.7)',
              'rgba(20, 184, 166, 0.7)'
            ],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'right',
            }
          }
        }
      });
    }

    // Cargar datos para filtros
    function cargarDatosFiltros() {
      // Cargar ni√±os para el filtro
      fetch('/api/ninos')
        .then(res => res.json())
        .then(ninos => {
          const filtroNino = document.getElementById('filtro-nino');
          ninos.forEach(nino => {
            const option = document.createElement('option');
            option.value = nino.id;
            option.textContent = `${nino.nombre} ${nino.apellidos}`;
            filtroNino.appendChild(option);
          });
          
          // Llenar filtro de grupos
          const grupos = [...new Set(ninos.map(n => n.grupo))].sort((a, b) => a - b);
          const filtroGrupo = document.getElementById('filtro-grupo');
          grupos.forEach(grupo => {
            const option = document.createElement('option');
            option.value = grupo;
            option.textContent = `Grupo ${grupo}`;
            filtroGrupo.appendChild(option);
          });
        });
    }

    // Cargar transacciones
    function cargarTransacciones(filtros = {}) {
      const params = new URLSearchParams(filtros);
      
      fetch(`/api/transacciones?${params}`)
        .then(res => res.json())
        .then(transacciones => {
          todasLasTransacciones = transacciones;
          transaccionesFiltradas = transacciones;
          paginaActual = 1;
          mostrarTransacciones();
          actualizarPaginacion();
          document.getElementById('total-resultados').textContent = `${transacciones.length} resultados`;
        })
        .catch(err => console.error('Error cargando transacciones:', err));
    }

    // Mostrar transacciones with paginaci√≥n
    function mostrarTransacciones() {
      const inicio = (paginaActual - 1) * transaccionesPorPagina;
      const fin = inicio + transaccionesPorPagina;
      const transaccionesPagina = transaccionesFiltradas.slice(inicio, fin);
      
      const container = document.getElementById('transacciones-lista');
      container.innerHTML = '';
      
      if (transaccionesPagina.length === 0) {
        container.innerHTML = '<div class="empty-transactions">No se encontraron transacciones</div>';
        return;
      }
      
      transaccionesPagina.forEach(transaccion => {
        const fecha = new Date(transaccion.fecha_hora);
        const fechaFormateada = fecha.toLocaleDateString('es-ES');
        const horaFormateada = fecha.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
        
        const card = document.createElement('div');
        card.className = 'transaction-card';
        card.innerHTML = `
          <div class="transaction-header">
            <div class="transaction-customer">
              <h3>${transaccion.nino_nombre}</h3>
              <span class="group-badge">Grupo ${transaccion.grupo || 'N/A'}</span>
            </div>
            <div class="transaction-amount">
              <div class="amount-actions">
                <span class="amount">${transaccion.total.toFixed(2)}‚Ç¨</span>
                <button class="btn-refund" onclick="reembolsarTransaccion(${transaccion.id}, '${transaccion.nino_nombre}', ${transaccion.total})" title="Reembolsar transacci√≥n">
                  ‚Ü©Ô∏è
                </button>
              </div>
              <span class="datetime">${fechaFormateada} ${horaFormateada}</span>
            </div>
          </div>
          <div class="transaction-products">
            <strong>Productos:</strong> ${transaccion.productos}
          </div>
        `;
        container.appendChild(card);
      });
    }

    // Nueva funci√≥n para reembolsar transacciones
    function reembolsarTransaccion(id, ninoNombre, total) {
      const modal = document.createElement('div');
      modal.className = 'refund-modal';
      modal.innerHTML = `
        <div class="refund-modal-content">
          <div class="refund-icon">‚Ü©Ô∏è</div>
          <h3>Confirmar reembolso</h3>
          <p>¬øEst√°s seguro de que deseas reembolsar esta transacci√≥n?</p>
          <div class="refund-details">
            <p><strong>Ni√±o:</strong> ${ninoNombre}</p>
            <p><strong>Importe:</strong> ‚Ç¨${total.toFixed(2)}</p>
          </div>
          <p class="warning-text">Esta acci√≥n eliminar√° la transacci√≥n y devolver√° el dinero al ni√±o.</p>
          <div class="refund-actions">
            <button class="btn-confirm-refund" onclick="confirmarReembolso(${id}, this)">
              <i>‚Ü©Ô∏è</i> S√≠, reembolsar
            </button>
            <button class="btn-cancel-refund" onclick="cerrarModalReembolso(this)">
              <i>‚ùå</i> Cancelar
            </button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    function confirmarReembolso(id, button) {
      // Show loading state
      button.innerHTML = '<i>‚è≥</i> Procesando...';
      button.disabled = true;
      
      fetch(`/api/transacciones/${id}`, { method: 'DELETE' })
        .then(res => res.json())
        .then(resp => {
          if (resp.success) {
            cerrarModalReembolso(button);
            // Recargar transacciones aplicando filtros actuales
            document.getElementById('aplicar-filtros').click();
            cargarEstadisticas(); // Actualizar estad√≠sticas
            mostrarNotificacion(
              `Reembolso exitoso: ‚Ç¨${resp.transaccion.total.toFixed(2)} devueltos a ${resp.transaccion.nino_nombre}`, 
              'success'
            );
          } else {
            mostrarNotificacion('Error: ' + (resp.error || 'No se pudo procesar el reembolso'), 'error');
            cerrarModalReembolso(button);
          }
        })
        .catch(err => {
          mostrarNotificacion('Error de conexi√≥n con el servidor', 'error');
          cerrarModalReembolso(button);
        });
    }

    function cerrarModalReembolso(element) {
      const modal = element.closest('.refund-modal');
      if (modal) {
        modal.remove();
      }
    }

    function mostrarNotificacion(mensaje, tipo = 'info') {
      const notification = document.createElement('div');
      notification.className = `notification notification-${tipo}`;
      notification.innerHTML = `
        <div class="notification-content">
          <span class="notification-icon">${tipo === 'success' ? '‚úÖ' : tipo === 'error' ? '‚ùå' : '‚ÑπÔ∏è'}</span>
          <span class="notification-message">${mensaje}</span>
        </div>
      `;
      
      document.body.appendChild(notification);
      
      // Auto remove after 4 seconds
      setTimeout(() => {
        if (notification.parentNode) {
          notification.style.opacity = '0';
          setTimeout(() => notification.remove(), 300);
        }
      }, 4000);
    }

    // Event listeners
    document.getElementById('aplicar-filtros').addEventListener('click', function() {
      const filtros = {};
      
      const fechaInicio = document.getElementById('fecha-inicio').value;
      const fechaFin = document.getElementById('fecha-fin').value;
      const ninoId = document.getElementById('filtro-nino').value;
      const grupo = document.getElementById('filtro-grupo').value;
      const busqueda = document.getElementById('busqueda-productos').value.trim();
      
      if (fechaInicio) filtros.fecha_inicio = fechaInicio;
      if (fechaFin) filtros.fecha_fin = fechaFin;
      if (ninoId) filtros.nino_id = ninoId;
      if (grupo) filtros.grupo = grupo;
      if (busqueda) filtros.busqueda = busqueda;
      
      cargarTransacciones(filtros);
    });

    document.getElementById('limpiar-filtros').addEventListener('click', function() {
      document.getElementById('fecha-inicio').value = '';
      document.getElementById('fecha-fin').value = '';
      document.getElementById('filtro-nino').value = '';
      document.getElementById('filtro-grupo').value = '';
      document.getElementById('busqueda-productos').value = '';
      cargarTransacciones();
    });

    document.getElementById('prev-page').addEventListener('click', function() {
      if (paginaActual > 1) {
        paginaActual--;
        mostrarTransacciones();
        actualizarPaginacion();
      }
    });

    document.getElementById('next-page').addEventListener('click', function() {
      const totalPaginas = Math.ceil(transaccionesFiltradas.length / transaccionesPorPagina);
      if (paginaActual < totalPaginas) {
        paginaActual++;
        mostrarTransacciones();
        actualizarPaginacion();
      }
    });

    document.getElementById('exportar-excel').addEventListener('click', function() {
      if (transaccionesFiltradas.length === 0) {
        alert('No hay datos para exportar');
        return;
      }
      // Prepara los datos para Excel
      const wsData = [
        ['Fecha', 'Hora', 'Ni√±o', 'Grupo', 'Productos', 'Total (‚Ç¨)']
      ];
      transaccionesFiltradas.forEach(t => {
        const fecha = new Date(t.fecha_hora);
        wsData.push([
          fecha.toLocaleDateString('es-ES'),
          fecha.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' }),
          t.nino_nombre,
          t.grupo || 'N/A',
          t.productos,
          t.total.toFixed(2)
        ]);
      });
      const ws = XLSX.utils.aoa_to_sheet(wsData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Transacciones');
      XLSX.writeFile(wb, `transacciones_${new Date().toISOString().split('T')[0]}.xlsx`);
    });

    // Inicializar
    cargarEstadisticas();
    cargarDatosFiltros();
    cargarTransacciones();
    
    // Cargar estad√≠sticas de tokens
    function cargarEstadisticasTokens() {
      fetch('/api/ninos')
        .then(res => res.json())
        .then(ninos => {
          // Calcular total de tokens
          const totalTokens = ninos.reduce((total, nino) => total + (nino.tokens || 0), 0);
          document.getElementById('total-tokens').textContent = totalTokens;
          
          // Encontrar el ni√±o con m√°s tokens
          let topNino = { nombre: '', apellidos: '', tokens: 0 };
          ninos.forEach(nino => {
            if ((nino.tokens || 0) > topNino.tokens) {
              topNino = { 
                nombre: nino.nombre, 
                apellidos: nino.apellidos, 
                tokens: nino.tokens || 0 
              };
            }
          });
          
          if (topNino.tokens > 0) {
            document.getElementById('top-tokens-nino').textContent = `${topNino.nombre} ${topNino.apellidos}`;
            document.getElementById('top-tokens-nino-cantidad').textContent = `${topNino.tokens} tokens`;
          }
          
          // Calcular tokens por grupo
          const gruposTokens = {};
          ninos.forEach(nino => {
            const grupo = nino.grupo;
            if (!gruposTokens[grupo]) {
              gruposTokens[grupo] = { 
                total: 0, 
                ninos: [] 
              };
            }
            gruposTokens[grupo].total += (nino.tokens || 0);
            gruposTokens[grupo].ninos.push({
              id: nino.id,
              nombre: nino.nombre,
              apellidos: nino.apellidos,
              tokens: nino.tokens || 0
            });
          });
          
          // Mostrar tokens por grupo
          const gruposContainer = document.getElementById('tokens-por-grupo');
          gruposContainer.innerHTML = '';
          
          // Calcular el tama√±o promedio de los grupos
          const totalGrupos = Object.keys(gruposTokens).length;
          const totalPersonas = Object.values(gruposTokens).reduce((sum, grupo) => sum + grupo.ninos.length, 0);
          const promedioPersonasPorGrupo = totalPersonas / totalGrupos;
          
          Object.keys(gruposTokens).sort((a, b) => a - b).forEach(grupo => {
            const grupoData = gruposTokens[grupo];
            
            // Calcular tokens reales (tokens por persona)
            const totalPersonasGrupo = grupoData.ninos.length;
            const tokensReales = totalPersonasGrupo > 0 ? (grupoData.total / totalPersonasGrupo) : 0;
            
            // Calcular tokens compensados por disparidad de tama√±o
            // Factor de compensaci√≥n: grupos peque√±os reciben bonificaci√≥n, grupos grandes penalizaci√≥n
            const factorCompensacion = promedioPersonasPorGrupo / totalPersonasGrupo;
            const tokensCompensados = tokensReales * factorCompensacion;
            
            // Determinar si el grupo es grande, peque√±o o promedio
            let tipoGrupo = '';
            let colorCompensacion = '';
            if (totalPersonasGrupo < promedioPersonasPorGrupo * 0.8) {
              tipoGrupo = 'Grupo peque√±o (+bonus)';
              colorCompensacion = '#059669'; // Verde para bonus
            } else if (totalPersonasGrupo > promedioPersonasPorGrupo * 1.2) {
              tipoGrupo = 'Grupo grande (-ajuste)';
              colorCompensacion = '#dc2626'; // Rojo para penalizaci√≥n
            } else {
              tipoGrupo = 'Grupo promedio';
              colorCompensacion = '#6b7280'; // Gris para neutral
            }
            
            // Ordenar ni√±os del grupo por tokens (de mayor a menor)
            const ninosOrdenados = grupoData.ninos
              .filter(nino => nino.tokens > 0)  // Solo mostrar ni√±os con tokens
              .sort((a, b) => b.tokens - a.tokens);
            
            const grupoCard = document.createElement('div');
            grupoCard.className = 'camp-stat-card';
            
            // Generar HTML del encabezado del grupo
            let grupoHTML = `
              <h3>Grupo ${grupo}</h3>
              <div class="camp-stat-value">
                <span class="camp-stat-day">${grupoData.total}</span>
                <span class="camp-stat-detail">tokens totales</span>
              </div>
              <div style="margin-top: 8px; padding: 8px 12px; background: rgba(202, 138, 4, 0.1); border-radius: 6px; border: 1px solid rgba(202, 138, 4, 0.3);">
                <div style="font-size: 0.9rem; color: #92400e; font-weight: 600;">
                  Tokens por persona: ${tokensReales.toFixed(1)}
                </div>
                <div style="font-size: 0.8rem; color: #a16207; margin-top: 2px;">
                  (${grupoData.total} tokens √∑ ${totalPersonasGrupo} personas)
                </div>
              </div>
              <div style="margin-top: 6px; padding: 8px 12px; background: rgba(0, 0, 0, 0.05); border-radius: 6px; border: 1px solid ${colorCompensacion};">
                <div style="font-size: 0.9rem; color: ${colorCompensacion}; font-weight: 700;">
                  Tokens Compensados: ${tokensCompensados.toFixed(1)}
                </div>
                <div style="font-size: 0.75rem; color: ${colorCompensacion}; margin-top: 2px;">
                  ${tipoGrupo} ‚Ä¢ Factor: ${factorCompensacion.toFixed(2)}x
                </div>
                <div style="font-size: 0.7rem; color: #64748b; margin-top: 3px;">
                  Promedio campamento: ${promedioPersonasPorGrupo.toFixed(1)} personas/grupo
                </div>
              </div>
            `;
            
            // A√±adir lista de ni√±os si hay tokens en el grupo
            if (ninosOrdenados.length > 0) {
              grupoHTML += `
                <div style="margin-top: 15px; border-top: 1px solid #e5e7eb; padding-top: 10px;">
                  <ul style="list-style: none; padding: 0; margin: 0; text-align: left; max-height: 300px; overflow-y: auto;">
              `;
              
              // Mostrar TODOS los ni√±os del grupo con tokens (sin l√≠mite)
              ninosOrdenados.forEach((nino, index) => {
                // Determinar medalla para los tres primeros lugares
                let medalla = '';
                if (index === 0) medalla = 'ü•á ';
                else if (index === 1) medalla = 'ü•à ';
                else if (index === 2) medalla = 'ü•â ';
                
                grupoHTML += `
                  <li style="display: flex; justify-content: space-between; padding: 4px 0; font-size: 0.9rem;">
                    <span style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 150px;">
                      ${medalla}${nino.nombre} ${nino.apellidos}
                    </span>
                    <span style="font-weight: 600; color: #ca8a04; margin-left: 5px;">
                      ${nino.tokens}ü™ô
                    </span>
                  </li>
                `;
              });
              
              grupoHTML += `</ul></div>`;
            } else {
              // Mostrar mensaje si no hay ni√±os con tokens
              grupoHTML += `
                <div style="margin-top: 15px; color: #6b7280; font-size: 0.9rem; font-style: italic; text-align: center;">
                  No hay tokens en este grupo
                </div>
              `;
            }
            
            grupoCard.innerHTML = grupoHTML;
            gruposContainer.appendChild(grupoCard);
          });
          
          // Crear ranking de ni√±os por tokens - limitado a top 5
          const ninosOrdenados = ninos
            .filter(nino => (nino.tokens || 0) > 0)
            .sort((a, b) => (b.tokens || 0) - (a.tokens || 0))
            .slice(0, 5); // Limitar a solo los 5 mejores
          
          const rankingContainer = document.getElementById('tokens-ranking');
          rankingContainer.innerHTML = '';
          
          if (ninosOrdenados.length === 0) {
            rankingContainer.innerHTML = '<div style="text-align:center;color:#64748b;padding:20px;">No hay tokens asignados todav√≠a</div>';
            return;
          }
          
          ninosOrdenados.forEach((nino, index) => {
            const rankingCard = document.createElement('div');
            rankingCard.className = 'transaction-card';
            rankingCard.style.display = 'flex';
            rankingCard.style.alignItems = 'center';
            rankingCard.style.justifyContent = 'space-between';
            rankingCard.style.padding = '16px 20px';
            
            // Determinamos la medalla seg√∫n la posici√≥n
            let medalla = '';
            if (index === 0) medalla = 'ü•á';
            else if (index === 1) medalla = 'ü•à';
            else if (index === 2) medalla = 'ü•â';
            else medalla = `${index + 1}.`;
            
            rankingCard.innerHTML = `
              <div style="display:flex;align-items:center;">
                <span style="font-size:1.4rem;margin-right:15px;min-width:40px;text-align:center;">${medalla}</span>
                <div>
                  <h3 style="margin:0;font-size:1.1rem;">${nino.nombre} ${nino.apellidos}</h3>
                  <span class="group-badge">Grupo ${nino.grupo}</span>
                </div>
              </div>
              <div style="font-size:1.3rem;font-weight:700;color:#ca8a04;">
                ${nino.tokens} ü™ô
              </div>
            `;
            
            rankingContainer.appendChild(rankingCard);
          });
        })
        .catch(err => console.error('Error cargando estad√≠sticas de tokens:', err));
    }
    
    // Llamar a la funci√≥n para cargar estad√≠sticas de tokens
    cargarEstadisticasTokens();
  </script>

  <style>
    /* ...existing styles... */

    .amount-actions {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .btn-refund {
      background: linear-gradient(45deg, #f59e0b, #d97706);
      color: white;
      border: none;
      padding: 6px 10px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9em;
      transition: all 0.2s ease;
      min-width: 35px;
    }

    .btn-refund:hover {
      background: linear-gradient(45deg, #d97706, #b45309);
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(217, 119, 6, 0.3);
    }

    .refund-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      animation: fadeIn 0.3s ease;
    }

    .refund-modal-content {
      background: white;
      padding: 30px;
      border-radius: 12px;
      max-width: 450px;
      width: 90%;
      text-align: center;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
      animation: slideUp 0.3s ease;
    }

    .refund-icon {
      font-size: 3em;
      margin-bottom: 15px;
      color: #f59e0b;
    }

    .refund-details {
      background: #f8fafc;
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
      text-align: left;
    }

    .refund-details p {
      margin: 5px 0;
      color: #475569;
    }

    .warning-text {
      color: #dc2626;
      font-weight: 500;
      font-size: 0.9em;
      margin: 15px 0;
    }

    .refund-actions {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin-top: 25px;
    }

    .btn-confirm-refund {
      background: linear-gradient(45deg, #f59e0b, #d97706);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s ease;
    }

    .btn-confirm-refund:hover:not(:disabled) {
      background: linear-gradient(45deg, #d97706, #b45309);
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(217, 119, 6, 0.3);
    }

    .btn-confirm-refund:disabled {
      opacity: 0.7;
      cursor: not-allowed;
    }

    .btn-cancel-refund {
      background: #6b7280;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s ease;
    }

    .btn-cancel-refund:hover {
      background: #4b5563;
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(107, 114, 128, 0.3);
    }

    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: white;
      border-radius: 8px;
      padding: 15px 20px;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
      z-index: 1001;
      animation: slideInRight 0.3s ease;
      max-width: 400px;
    }

    .notification-success {
      border-left: 4px solid #10b981;
    }

    .notification-error {
      border-left: 4px solid #ef4444;
    }

    .notification-content {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .notification-icon {
      font-size: 1.2em;
    }

    .notification-message {
      color: #374151;
      font-weight: 500;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes slideUp {
      from { transform: translateY(30px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    @keyframes slideInRight {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
  </style>
</body>
</html>
